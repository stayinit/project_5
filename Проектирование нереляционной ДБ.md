# Проектирование хранилища для сервиса аутентификации и авторизации в нереляционной СУБД

## 1. Выбор типа NoSQL
**Документное хранилище (MongoDB)**.

## 2. Обоснование выбора

### Почему подходит:
- **Гибкая схема**: профили пользователей, устройства, MFA-настройки, внешние провайдеры входа сильно варьируются — удобно хранить как документы с динамическими полями.
- **Шардирование по `user_id` / `tenant_id`**: горизонтально масштабируется на чтения/записи.
- **TTL-индексы**: нативно очищают просроченные сессии/одноразовые коды/refresh-токены.
- **Транзакции и уникальные индексы**: нужны для атомарной регистрации, брони логина/е-мейла, ротации токена.
- **Запросы по вложенным структурам**: быстрый доступ к ролям/политикам, устройствам пользователя.

### Преимущества в кейсе:
- **Естественное моделирование RBAC/ABAC** (roles/permissions/policies) как документов; можно как встраивать (embed), так и ссылаться (reference).
- **Высокая скорость типичных операций AA**: get user by login, validate session, revoke token, list user roles.
- **Удобные частичные индексы и compound-индексы** под горячие запросы (email/username + tenant, jti, device_id).

### Ограничения/риски:
- **Жёсткие join’ы отсутствуют** — осознанный выбор между встраиванием и ссылками; возможная денормализация.
- **Последовательность в распределённой среде**: по умолчанию eventual consistency на чтениях с вторичных реплик; критичные проверки (логин, refresh) направлять на primary.
- **Размер документа (16 МБ)** — крупные журналы аудита/истории хранить отдельно, не в профиле.
- **Миграции схемы**: дисциплина схем-валидаторов и версионирования.

## 3. Структура данных

### Коллекции (основные):
- `users` — учётные записи и профиль.
- `roles` — роли на уровне арендатора/системы.
- `permissions` — атомарные права (опционально, если не храним их инлайн в роли).
- `policies` — политики доступа (RBAC/ABAC), условия по атрибутам.
- `sessions` — активные сессии (TTL).
- `refresh_tokens` — refresh-токены (TTL, rotation).
- `devices` — привязанные устройства/ключи (WebAuthn, TOTP, push).
- `audit_logs` — события входа/выхода/сброса пароля (тяжёлый поток, партиционировать).
- `tenants` — организации/арендаторы (если multi-tenant).

### Модель связей и вложенности:
- **Пользователь - роли**: храним массив `role_ids` в `users` и кэшируем развёрнутые роли в поле `effective_permissions` (денормализация для быстрого check). При изменении роли инкрементируем `role_version` и помечаем пользователей на пересчёт.
- **Сессии/токены**: отдельные коллекции с TTL, связь по `user_id`.
- **Устройства**: отдельные документы, ссылка на `user_id`. Чувствительные ключи в зашифрованных полях (FLE/внешнее шифрование).
- **Политики (ABAC)**: условия в JSON (например, по времени, IP, отделу), применяются при проверке доступа.

## 4. Примеры документов (JSON)

### 4.1 users
```json
{
  "_id": { "$oid": "66b9f0a1e4b0f12345678901" },
  "tenant_id": "acme",
  "email": "Alice@example.com",
  "emailLower": "alice@example.com",
  "username": "alice",
  "usernameLower": "alice",
  "status": "active",
  "password": {
    "alg": "argon2id",
    "hash": "$argon2id$v=19$m=65536,t=3,p=1$...",
    "pwd_last_changed_at": "2025-06-12T10:15:00Z"
  },
  "mfa": {
    "required": true,
    "methods": ["totp", "webauthn"],
    "totp": { "secret_ref": "kms://secrets/acme/u/alice/totp", "enabled": true }
  },
  "roles": ["66b9f0a1e4b0f12345678001", "66b9f0a1e4b0f12345678002"],
  "effective_permissions": [
    {"action": "read", "resource": "projects:*"},
    {"action": "write", "resource": "projects:own"}
  ],
  "external_ids": [
    {"provider": "google", "subject": "113123123123"},
    {"provider": "github", "subject": "987654"}
  ],
  "attributes": { "dept": "engineering", "country": "NL" },
  "created_at": "2025-05-01T09:00:00Z",
  "updated_at": "2025-07-20T14:05:00Z",
  "version": 7
}
### 4.2 roles
{
  "_id": { "$oid": "66b9f0a1e4b0f12345678001" },
  "tenant_id": "acme",
  "name": "project_editor",
  "description": "Edit own project data",
  "permissions": [
    {"action": "read", "resource": "projects:*"},
    {"action": "write", "resource": "projects:own"}
  ],
  "updated_at": "2025-07-10T08:00:00Z",
  "version": 3
}
### 4.3 policies (ABAC правило)
{
  "_id": { "$oid": "66b9f0a1e4b0f12345678099" },
  "tenant_id": "acme",
  "name": "office-hours-nl",
  "effect": "deny",
  "resource": "projects:*",
  "condition": {
    "any": [
      {"notInCidr": {"ip": "request.ip", "cidr": ["10.0.0.0/8", "192.168.0.0/16"]}},
      {"notBetweenTime": {"tz": "Europe/Amsterdam", "from": "08:00", "to": "20:00"}}
    ]
  },
  "updated_at": "2025-06-28T12:00:00Z"
}
### 4.4 sessions (TTL по expires_at)
{
  "_id": { "$oid": "66c0aa0ae4b0f12345670001" },
  "session_id": "s_1J7d...X",
  "user_id": { "$oid": "66b9f0a1e4b0f12345678901" },
  "tenant_id": "acme",
  "created_at": "2025-08-13T07:45:00Z",
  "expires_at": "2025-08-20T07:45:00Z",
  "ip": "203.0.113.10",
  "ua": "Mozilla/5.0",
  "mfa_passed": true,
  "status": "active",
  "claims": {
    "sub": "66b9f0a1e4b0f12345678901",
    "scp": ["projects:read", "projects:write:own"],
    "aud": ["api.acme.internal"],
    "iss": "auth.acme"
  }
}
### 4.5 refresh_tokens (Rotation & TTL)
{
  "_id": { "$oid": "66c0ab33e4b0f12345670077" },
  "jti": "rt_9Qx...kA",
  "parent_jti": "rt_7Lm...Zp",
  "user_id": { "$oid": "66b9f0a1e4b0f12345678901" },
  "tenant_id": "acme",
  "session_id": "s_1J7d...X",
  "issued_at": "2025-08-13T07:45:05Z",
  "expires_at": "2025-09-12T07:45:05Z",
  "revoked": false,
  "scope": ["offline_access"],
  "fingerprint": "FPr1...=="
}
